<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <title>Dashboard - PeerEval Pro</title>

  <!-- Define global BACKEND_URL before any scripts -->
  <script>
    window.BACKEND_URL = "http://127.0.0.1:8000";
  </script>

  <!-- Page protection -->
  <script src="protected.js"></script>
</head>
<body class="dashboard-body signup-page">
  <!-- Top Navigation Bar -->
  <nav class="dashboard-nav">
    <div class="nav-brand">
      <span class="brand-icon">üìä</span>
      <span class="brand-text">PeerEval Pro</span>
    </div>
    <div class="nav-user">
      <div class="user-profile">
        <div class="user-avatar">
          <span id="userInitial">U</span>
        </div>
        <div class="user-details">
          <span class="user-name" id="userNameDisplay">User</span>
          <span class="user-role" id="userRoleDisplay">Student</span>
        </div>
      </div>
      <button id="logoutBtn" class="logout-btn-nav">
        <span>üö™</span>
        <span>Logout</span>
      </button>
    </div>
  </nav>

  <!-- Main Dashboard Container -->
  <div class="dashboard-container">
    <!-- Welcome Header -->
    <div class="dashboard-welcome">
      <h1 id="welcomeText">Welcome back!</h1>
      <p class="welcome-subtitle">Manage your peer reviews and track your team activity</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card stat-primary">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-value" id="teamCount">-</div>
          <div class="stat-label">Team Members</div>
        </div>
      </div>
      <div class="stat-card stat-secondary">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-content">
          <div class="stat-value">Ready</div>
          <div class="stat-label">Review Status</div>
        </div>
      </div>
      <div class="stat-card stat-success">
        <div class="stat-icon">üìù</div>
        <div class="stat-content">
          <div class="stat-value">Active</div>
          <div class="stat-label">Session Status</div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="dashboard-grid">
      <!-- Team Members Card -->
      <section class="dashboard-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="card-icon">üë•</span>
            Team Members
          </h2>
        </div>
        <div class="card-body">
          <div id="teamMembers" class="team-members-grid"></div>
          <p id="teamError" class="error"></p>
        </div>
      </section>

      <!-- Instructor Controls Card (only for instructors) -->
      <section id="instructorControlsCard" class="dashboard-card" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">
            <span class="card-icon">üë®‚Äçüè´</span>
            Instructor Controls
          </h2>
        </div>
        <div class="card-body">
          <div class="instructor-controls-content">
            <p style="color: #64748b; margin-bottom: 24px;">
              Monitor student submissions and publish results when ready.
            </p>
            
            <!-- Submission Deadline -->
            <div id="deadlineCard" style="margin-bottom: 28px; background: #ffffff; border-radius: 16px; padding: 0; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04); overflow: hidden;">
              <!-- Header -->
              <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 20px 24px; display: flex; align-items: center; gap: 14px;">
                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.15); backdrop-filter: blur(8px); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1);">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                    <circle cx="12" cy="16" r="2"></circle>
                  </svg>
                </div>
                <div>
                  <h3 style="font-size: 17px; font-weight: 600; color: #ffffff; margin: 0; letter-spacing: -0.01em;">Submission Deadline</h3>
                  <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 3px 0 0 0;">Control when students can submit reviews</p>
                </div>
              </div>
              
              <div id="deadlineContent" style="padding: 24px;">
                <!-- Status Display -->
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 18px 20px; margin-bottom: 24px; border: 1px solid #e2e8f0;">
                  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div>
                      <div style="font-size: 11px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px;">Current Status</div>
                      <div id="currentDeadlineDisplay" style="font-size: 15px; color: #334155; font-weight: 500; line-height: 1.4;"></div>
                    </div>
                    <span id="deadlineStatusBadge" style="padding: 8px 18px; border-radius: 24px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px;">Loading...</span>
                  </div>
                </div>
                
                <!-- Date/Time Input -->
                <div style="margin-bottom: 20px;">
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Set New Deadline
                  </label>
                  
                  <!-- Date Row -->
                  <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                    <div style="flex: 1;">
                      <label style="display: block; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Month</label>
                      <select id="deadlineMonth" style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-weight: 500; color: #1f2937; background: #ffffff; cursor: pointer; transition: all 0.2s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%236b7280%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center;">
                        <option value="">Month</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                      </select>
                    </div>
                    <div style="width: 90px;">
                      <label style="display: block; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Day</label>
                      <select id="deadlineDay" style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-weight: 500; color: #1f2937; background: #ffffff; cursor: pointer; transition: all 0.2s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%236b7280%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center;">
                        <option value="">Day</option>
                      </select>
                    </div>
                    <div style="width: 100px;">
                      <label style="display: block; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Year</label>
                      <select id="deadlineYear" style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-weight: 500; color: #1f2937; background: #ffffff; cursor: pointer; transition: all 0.2s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%236b7280%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center;">
                        <option value="">Year</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Time Row -->
                  <div style="display: flex; gap: 10px; align-items: end;">
                    <div style="width: 100px;">
                      <label style="display: block; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Hour</label>
                      <select id="deadlineHour" style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-weight: 500; color: #1f2937; background: #ffffff; cursor: pointer; transition: all 0.2s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%236b7280%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center;">
                        <option value="">Hour</option>
                      </select>
                    </div>
                    <div style="font-size: 20px; font-weight: 600; color: #9ca3af; padding-bottom: 12px;">:</div>
                    <div style="width: 100px;">
                      <label style="display: block; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Minute</label>
                      <select id="deadlineMinute" style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-weight: 500; color: #1f2937; background: #ffffff; cursor: pointer; transition: all 0.2s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%236b7280%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center;">
                        <option value="">Min</option>
                      </select>
                    </div>
                    <div style="flex: 1;"></div>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px;">
                  <button id="setDeadlineBtn" type="button" style="padding: 14px 28px; background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(79, 70, 229, 0.35)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(79, 70, 229, 0.25)'">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Set Deadline</span>
                  </button>
                  <button id="clearDeadlineBtn" type="button" style="padding: 14px 20px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; color: #6b7280; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease;" onmouseover="this.style.borderColor='#10b981'; this.style.color='#059669'; this.style.background='#ecfdf5'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280'; this.style.background='#ffffff'">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                    </svg>
                    <span>Reopen</span>
                  </button>
                </div>
                
                <div id="deadlineMessage" class="msg" style="margin-top: 16px; padding: 12px 16px; border-radius: 10px; display: none;"></div>
              </div>
            </div>

            <!-- Submission Status -->
            <div id="submissionStatusCard" class="submission-status-card" style="margin-bottom: 24px;">
              <div class="submission-status-header">
                <h3 style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0;">
                  Submission Status
                </h3>
              </div>
              <div id="submissionStatusContent" class="submission-status-content">
                <div style="text-align: center; padding: 20px; color: #64748b;">
                  <div class="report-loading-spinner" style="margin: 0 auto 12px;"></div>
                  <p style="margin: 0;">Loading submission status...</p>
                </div>
              </div>
            </div>
            
            <!-- Publish Status -->
            <div id="publishStatus" class="publish-status" style="margin-bottom: 20px;">
              <div class="publish-status-item">
                <span class="publish-status-label">Publish Status:</span>
                <span id="publishStatusText" class="publish-status-value">Checking...</span>
              </div>
            </div>
            
            <!-- Publish Button -->
            <button id="publishResultsBtn" type="button" class="submit-btn-primary">
              <span class="btn-icon">üì¢</span>
              <span>Publish Results</span>
            </button>
            <div id="publishMessage" class="msg" aria-live="polite" style="margin-top: 16px;"></div>
            
            <!-- Student Reports Section -->
            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e2e8f0;">
              <h3 style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0 0 16px 0;">
                Student Reports
              </h3>
              <div id="studentReportsList" class="student-reports-list">
                <div style="text-align: center; padding: 20px; color: #64748b;">
                  <div class="report-loading-spinner" style="margin: 0 auto 12px;"></div>
                  <p style="margin: 0;">Loading student reports...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Peer Review Report Card (only for students) -->
      <section id="studentReportCard" class="dashboard-card">
        <div class="card-header">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">
              <span class="card-icon">üìä</span>
              Peer Review Report
            </h2>
            <div style="display: flex; gap: 12px; align-items: center;">
              <a href="results.html" style="text-decoration: none; color: #667eea; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                <span>My Reviews</span>
                <span>‚Üí</span>
              </a>
              <a href="all-results.html" style="text-decoration: none; color: #667eea; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                <span>All Results</span>
                <span>‚Üí</span>
              </a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Loading State -->
          <div id="reportLoadingState" class="report-loading-state">
            <div class="report-loading-spinner"></div>
            <p>Loading report data...</p>
          </div>

          <!-- Error State -->
          <div id="reportErrorState" class="report-error-state" style="display: none;">
            <div class="report-error-icon">‚ö†Ô∏è</div>
            <p id="reportErrorMessage" class="error"></p>
          </div>

          <!-- Report Preview Content -->
          <div id="reportPreviewContent" style="display: none;">
            <!-- Overall Score Display -->
            <div class="report-overall-score">
              <div class="report-score-label">Overall Performance</div>
              <div id="reportOverallScore" class="report-score-value">-</div>
              <div class="report-score-scale">out of 5.0</div>
            </div>

            <!-- Quick Stats -->
            <div class="report-stats-grid">
              <div class="report-stat-item">
                <div class="report-stat-icon">üìù</div>
                <div class="report-stat-content">
                  <div id="reportTotalReviews" class="report-stat-value">0</div>
                  <div class="report-stat-label">Total Reviews</div>
                </div>
              </div>
              <div class="report-stat-item">
                <div class="report-stat-icon">üë•</div>
                <div class="report-stat-content">
                  <div id="reportUniqueReviewers" class="report-stat-value">0</div>
                  <div class="report-stat-label">Reviewers</div>
                </div>
              </div>
              <div class="report-stat-item">
                <div class="report-stat-icon">üìã</div>
                <div class="report-stat-content">
                  <div id="reportCriteriaCount" class="report-stat-value">0</div>
                  <div class="report-stat-label">Criteria</div>
                </div>
              </div>
            </div>

            <!-- Top Criteria Preview -->
            <div id="reportCriteriaPreview" class="report-criteria-preview"></div>
          </div>

          <!-- No Data State -->
          <div id="reportNoDataState" class="report-no-data-state" style="display: none;">
            <div class="report-no-data-icon">üìä</div>
            <p class="report-no-data-title" id="noDataTitle">No Report Data Available</p>
            <p class="report-no-data-message" id="noDataMessage">Your peer review report will appear here once reviews are submitted and results are published.</p>
            <div style="margin-top: 20px;">
              <button id="refreshReportBtn" type="button" class="submit-btn-primary" style="max-width: 200px; margin: 0 auto; display: none;">
                <span class="btn-icon">üîÑ</span>
                <span>Refresh</span>
              </button>
              <p style="font-size: 12px; color: #94a3b8; margin-top: 12px; margin-bottom: 0;">
                The page will automatically check for published results every 30 seconds.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Submit Review Card -->
      <section id="submitReviewCard" class="dashboard-card dashboard-card-wide review-card">
        <div class="card-header">
          <div class="card-header-content">
            <h2 class="card-title">
              <span class="card-icon">‚úçÔ∏è</span>
              Submit Peer Review
            </h2>
            <p class="card-subtitle">Provide honest and constructive feedback for your teammates</p>
          </div>
        </div>
        <div class="card-body review-form-body">
          <!-- Step 1: Select Teammate -->
          <div class="form-step">
            <div class="step-header">
              <span class="step-number">1</span>
              <div class="step-title-group">
                <label for="teammateSelect" class="form-label-large">
                  Select Teammate
                  <span class="required-indicator">*</span>
                </label>
                <p class="form-help-text">Choose the teammate you want to review</p>
              </div>
            </div>
            <div class="form-input-wrapper">
              <select id="teammateSelect" class="form-select-enhanced">
                <option value="">-- Select a teammate --</option>
              </select>
              <span class="input-icon">üë§</span>
            </div>
          </div>

          <!-- Step 2: Rating Criteria -->
          <div class="form-step rating-step">
            <div class="step-header">
              <span class="step-number">2</span>
              <div class="step-title-group">
                <label class="form-label-large">Rating Criteria</label>
                <p class="form-help-text">Rate your teammate on the following criteria</p>
              </div>
            </div>
            <!-- Rating inputs will be rendered here by rating.js -->
            <div id="ratingContainer" class="rating-container-enhanced"></div>
          </div>

          <!-- Step 3: Additional Comments -->
          <div class="form-step">
            <div class="step-header">
              <span class="step-number">3</span>
              <div class="step-title-group">
                <label for="commentBox" class="form-label-large">
                  Additional Comments
                  <span class="optional-badge">Optional</span>
                </label>
                <p class="form-help-text">Share detailed feedback or suggestions (max 500 characters)</p>
              </div>
            </div>
            <div class="form-input-wrapper textarea-wrapper">
              <textarea
                id="commentBox"
                rows="5"
                maxlength="500"
                class="form-textarea-enhanced"
                placeholder="Provide constructive feedback that will help your teammate improve. Be specific and actionable in your comments..."></textarea>
              <div class="textarea-footer">
                <div id="commentCount" class="comment-counter-enhanced">
                  <span class="char-count">0</span>
                  <span class="char-separator">/</span>
                  <span class="char-max">500</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Section -->
          <div class="form-submit-section">
            <button id="confirmDetailsBtn" type="button" class="submit-btn-primary">
              <span class="btn-icon">‚úì</span>
              <span>Confirm Details</span>
            </button>
            <div id="submitMessage" class="msg" aria-live="polite"></div>
          </div>

          <!-- Confirmation Review Section -->
          <div id="confirmationSection" class="confirmation-section" style="display: none;">
            <div class="confirmation-header">
              <h3 class="confirmation-title">
                <span class="confirmation-icon">üìã</span>
                Review Your Submission
              </h3>
              <p class="confirmation-subtitle">Please review your details before submitting</p>
            </div>

            <div class="confirmation-content">
              <!-- Teammate Info -->
              <div class="confirmation-item">
                <div class="confirmation-label">Teammate:</div>
                <div id="confirmationTeammate" class="confirmation-value">-</div>
              </div>

              <!-- Ratings Summary -->
              <div class="confirmation-item">
                <div class="confirmation-label">Ratings:</div>
                <div id="confirmationRatings" class="confirmation-ratings-list"></div>
              </div>

              <!-- Comments -->
              <div class="confirmation-item">
                <div class="confirmation-label">Comments:</div>
                <div id="confirmationComments" class="confirmation-value">
                  <em style="color: #94a3b8;">No comments provided</em>
                </div>
              </div>
            </div>

            <!-- Confirmation Actions -->
            <div class="confirmation-actions">
              <button id="deleteSubmissionBtn" type="button" class="delete-btn-secondary">
                <span class="btn-icon">üóëÔ∏è</span>
                <span>Delete</span>
              </button>
              <button id="editSubmissionBtn" type="button" class="edit-btn-secondary">
                <span class="btn-icon">‚úèÔ∏è</span>
                <span>Edit</span>
              </button>
              <button id="submitReviewBtn" type="button" class="submit-btn-primary">
                <span class="btn-icon">‚úì</span>
                <span>Review</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Load scripts after DOM -->
  <script src="team.js"></script>
  <script src="rating.js"></script>

  <script>
    // Initialize dashboard
    document.addEventListener("DOMContentLoaded", () => {
      const username = localStorage.getItem("username") || "User";
      const role = localStorage.getItem("role") || "student";
      
      // Update welcome text
      document.getElementById("welcomeText").textContent = `Welcome, ${username}!`;
      
      // Update user profile
      const userNameDisplay = document.getElementById("userNameDisplay");
      const userRoleDisplay = document.getElementById("userRoleDisplay");
      const userInitial = document.getElementById("userInitial");
      
      if (userNameDisplay) userNameDisplay.textContent = username;
      if (userRoleDisplay) userRoleDisplay.textContent = role.charAt(0).toUpperCase() + role.slice(1);
      if (userInitial) userInitial.textContent = username.charAt(0).toUpperCase();

      // Function to update team count
      function updateTeamCount() {
        const teamMembers = document.getElementById("teamMembers");
        const teamCountEl = document.getElementById("teamCount");
        if (teamMembers && teamCountEl) {
          const memberCards = teamMembers.querySelectorAll('.member-card');
          const mutedText = teamMembers.querySelector('.muted');
          // If there's a "No teammates" message, count is 0
          if (mutedText && mutedText.textContent.includes("No teammates")) {
            teamCountEl.textContent = "0";
          } else {
            teamCountEl.textContent = memberCards.length > 0 ? memberCards.length : "0";
          }
        }
      }
      
      // Logout handler
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("username");
        localStorage.removeItem("role");
        localStorage.removeItem("access_token");
        window.location.href = "login.html";
      });

      // Watch for team members changes using MutationObserver
      const teamMembersContainer = document.getElementById("teamMembers");
      if (teamMembersContainer && window.MutationObserver) {
        const observer = new MutationObserver(() => {
          updateTeamCount();
        });
        observer.observe(teamMembersContainer, {
          childList: true,
          subtree: true
        });
      }
      
      // Initial count update (with delay to allow team.js to load)
      setTimeout(updateTeamCount, 500);

      // Show/hide content based on role
      if (role === "instructor") {
        // Hide student-specific content
        document.getElementById("studentReportCard").style.display = "none";
        document.getElementById("statsGrid").style.display = "none";
        // Hide team members card (instructors don't have teammates)
        const teamMembersCard = document.getElementById("teamMembersCard");
        if (teamMembersCard) {
          teamMembersCard.style.display = "none";
        }
        // Hide submit review card (instructors don't submit reviews)
        const submitReviewCard = document.getElementById("submitReviewCard");
        if (submitReviewCard) {
          submitReviewCard.style.display = "none";
        }
        // Show instructor controls
        document.getElementById("instructorControlsCard").style.display = "block";
        // Load deadline, submission status, publish status, student reports and setup buttons
        loadDeadlineStatus();
        setupDeadlineButtons();
        loadSubmissionStatus();
        loadPublishStatus();
        setupPublishButton();
        // Load student reports with a small delay to ensure DOM is ready
        setTimeout(() => {
          loadStudentReports();
        }, 100);
      } else {
        // Hide instructor controls
        document.getElementById("instructorControlsCard").style.display = "none";
        // Show student content
        document.getElementById("studentReportCard").style.display = "block";
        // Load peer review report preview
        loadReportPreview();
        // Check deadline for student submit button
        checkDeadlineForStudent();
        
        // Setup refresh button for report
        const refreshReportBtn = document.getElementById("refreshReportBtn");
        if (refreshReportBtn) {
          refreshReportBtn.addEventListener("click", () => {
            loadReportPreview();
          });
        }
        
        // Auto-refresh report preview every 30 seconds to check if results are published
        // This allows students to see reports without manually refreshing after instructor publishes
        if (role === "student") {
          setInterval(() => {
            // Only refresh if we're showing the "no data" state (results not published)
            const noDataState = document.getElementById("reportNoDataState");
            if (noDataState && noDataState.style.display !== "none") {
              console.log("Auto-checking for published results...");
              loadReportPreview();
            }
          }, 30000); // Check every 30 seconds
        }
      }
    });

    // Load and display report preview (make it globally accessible)
    window.loadReportPreview = async function loadReportPreview() {
      const token = localStorage.getItem("access_token");
      const role = localStorage.getItem("role") || "student";
      
      // Only load report for students (instructors can view reports on report.html)
      if (role !== "student") {
        document.getElementById("reportLoadingState").style.display = "none";
        document.getElementById("reportNoDataState").style.display = "block";
        return;
      }

      if (!token) {
        hideReportLoading();
        showReportError("You are not logged in.");
        return;
      }

      const loadingState = document.getElementById("reportLoadingState");
      const errorState = document.getElementById("reportErrorState");
      const previewContent = document.getElementById("reportPreviewContent");
      const noDataState = document.getElementById("reportNoDataState");

      // Show loading state
      loadingState.style.display = "block";
      errorState.style.display = "none";
      previewContent.style.display = "none";
      noDataState.style.display = "none";

      try {
        const url = `${window.BACKEND_URL}/peer-reviews/report`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        let res;
        try {
          res = await fetch(url, {
            method: "GET",
            headers: {
              "Authorization": `Bearer ${token}`,
            },
            signal: controller.signal,
          });
          clearTimeout(timeoutId);
        } catch (fetchError) {
          clearTimeout(timeoutId);
          hideReportLoading();
          
          if (fetchError.name === 'AbortError') {
            showReportError("Request timed out. Please try again later.");
            return;
          }
          
          if (fetchError.message && (fetchError.message.includes("Failed to fetch") || fetchError.message.includes("NetworkError"))) {
            showReportError("Unable to connect to server. Please check your connection.");
            return;
          }
          
          showReportError("Failed to load report data.");
          return;
        }

        // Handle response
        if (!res.ok) {
          hideReportLoading();
          
          if (res.status === 403) {
            // Results not published yet - show no data state with helpful message
            loadingState.style.display = "none";
            errorState.style.display = "none";
            previewContent.style.display = "none";
            noDataState.style.display = "block";
            
            // Update the message to be more specific
            const noDataTitle = document.getElementById("noDataTitle");
            const noDataMessage = document.getElementById("noDataMessage");
            if (noDataTitle) {
              noDataTitle.textContent = "Results Not Published Yet";
            }
            if (noDataMessage) {
              noDataMessage.textContent = "Your peer review report will appear here once the instructor publishes the results. The page will automatically refresh when results are available.";
            }
            
            // Show refresh button
            const refreshBtn = document.getElementById("refreshReportBtn");
            if (refreshBtn) {
              refreshBtn.style.display = "inline-flex";
            }
            return;
          } else if (res.status === 401) {
            showReportError("You are not logged in.");
            localStorage.removeItem("access_token");
            localStorage.removeItem("isLoggedIn");
            return;
          } else {
            showReportError("Failed to load report data.");
            return;
          }
        }

        const data = await res.json();
        
        console.log("Report data received:", data);
        
        // Check if there's actual data - show report if we have any meaningful data
        if (!data) {
          hideReportLoading();
          loadingState.style.display = "none";
          errorState.style.display = "none";
          previewContent.style.display = "none";
            noDataState.style.display = "block";
            
            // Show refresh button
            const refreshBtn = document.getElementById("refreshReportBtn");
            if (refreshBtn) {
              refreshBtn.style.display = "inline-flex";
            }
            return;
          }

        // Check if we have any reviews or scores to display
        const hasReviews = data.total_reviews && data.total_reviews > 0;
        const hasScores = data.criterion_scores && data.criterion_scores.length > 0;
        const hasOverallScore = data.overall_score !== null && data.overall_score !== undefined;
        
        if (!hasReviews && !hasScores && !hasOverallScore) {
          hideReportLoading();
          loadingState.style.display = "none";
          errorState.style.display = "none";
          previewContent.style.display = "none";
          noDataState.style.display = "block";
          
          // Show refresh button
          const refreshBtn = document.getElementById("refreshReportBtn");
          if (refreshBtn) {
            refreshBtn.style.display = "inline-flex";
          }
          return;
        }

        // Display report preview
        displayReportPreview(data);
        
        // Hide refresh button if report is showing
        const refreshBtn = document.getElementById("refreshReportBtn");
        if (refreshBtn) {
          refreshBtn.style.display = "none";
        }
        
      } catch (err) {
        console.error("Error loading report preview:", err);
        hideReportLoading();
        showReportError("An error occurred while loading your report.");
      }
    }

    function displayReportPreview(data) {
      console.log("Displaying report preview with data:", data);
      
      const loadingState = document.getElementById("reportLoadingState");
      const errorState = document.getElementById("reportErrorState");
      const previewContent = document.getElementById("reportPreviewContent");
      const noDataState = document.getElementById("reportNoDataState");

      // Hide all states
      loadingState.style.display = "none";
      errorState.style.display = "none";
      noDataState.style.display = "none";
      
      // Show preview content
      previewContent.style.display = "block";
      
      console.log("Report preview content should now be visible");

      // Display overall score
      const overallScoreEl = document.getElementById("reportOverallScore");
      if (data.overall_score !== null && data.overall_score !== undefined) {
        overallScoreEl.textContent = data.overall_score.toFixed(2);
        
        // Color based on score
        const score = data.overall_score;
        if (score >= 4) {
          overallScoreEl.style.color = "#10b981"; // green
        } else if (score >= 3) {
          overallScoreEl.style.color = "#f59e0b"; // amber
        } else {
          overallScoreEl.style.color = "#ef4444"; // red
        }
      } else {
        overallScoreEl.textContent = "N/A";
        overallScoreEl.style.color = "#6b7280";
      }

      // Display stats (handle undefined/null values)
      const totalReviews = data.total_reviews !== undefined && data.total_reviews !== null ? data.total_reviews : 0;
      const uniqueReviewers = data.unique_reviewers !== undefined && data.unique_reviewers !== null ? data.unique_reviewers : 0;
      const criteriaCount = data.criterion_scores && Array.isArray(data.criterion_scores) ? data.criterion_scores.length : 0;
      
      document.getElementById("reportTotalReviews").textContent = totalReviews;
      document.getElementById("reportUniqueReviewers").textContent = uniqueReviewers;
      document.getElementById("reportCriteriaCount").textContent = criteriaCount;

      // Display all criteria in a list format
      const criteriaPreview = document.getElementById("reportCriteriaPreview");
      if (data.criterion_scores && data.criterion_scores.length > 0) {
        // Show all criteria, not just top 3
        criteriaPreview.innerHTML = data.criterion_scores.map((criterion, index) => {
          const score = criterion.average_score || 0;
          const maxScore = 5;
          const percentage = (score / maxScore) * 100;
          
          let scoreColor = "#6b7280";
          if (score >= 4) {
            scoreColor = "#10b981";
          } else if (score >= 3) {
            scoreColor = "#f59e0b";
          } else {
            scoreColor = "#ef4444";
          }

          return `
            <div class="report-criterion-item">
              <div class="report-criterion-header">
                <span class="report-criterion-title">${criterion.criterion_title}</span>
                <span class="report-criterion-score" style="color: ${scoreColor};">${score.toFixed(2)}</span>
              </div>
              <div class="report-criterion-bar">
                <div class="report-criterion-bar-fill" style="width: ${percentage}%; background: ${scoreColor};"></div>
              </div>
            </div>
          `;
        }).join("");
      } else {
        // If no criteria scores but we have other data, show a message
        criteriaPreview.innerHTML = '<p style="text-align: center; color: #64748b; padding: 16px;">No criterion scores available yet.</p>';
      }
    };

    function hideReportLoading() {
      document.getElementById("reportLoadingState").style.display = "none";
    }

    function showReportError(message) {
      const loadingState = document.getElementById("reportLoadingState");
      const errorState = document.getElementById("reportErrorState");
      const previewContent = document.getElementById("reportPreviewContent");
      const noDataState = document.getElementById("reportNoDataState");

      loadingState.style.display = "none";
      previewContent.style.display = "none";
      noDataState.style.display = "none";
      errorState.style.display = "block";
      document.getElementById("reportErrorMessage").textContent = message;
    }

    // Global variable to track submission status
    window.submissionsOpen = true;

    // Check deadline status for students and disable submit button if closed
    async function checkDeadlineForStudent() {
      const token = localStorage.getItem("access_token");
      if (!token) return;

      try {
        const res = await fetch(`${window.BACKEND_URL}/deadline`, {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` },
        });

        if (res.ok) {
          const data = await res.json();
          window.submissionsOpen = data.is_open;
          updateStudentSubmitButton(data.is_open, data.deadline);
        }
      } catch (err) {
        console.error("Error checking deadline:", err);
      }
    }

    function updateStudentSubmitButton(isOpen, deadline) {
      const confirmBtn = document.getElementById("confirmDetailsBtn");
      const submitBtn = document.getElementById("submitReviewBtn");
      const submitMessage = document.getElementById("submitMessage");

      if (!isOpen) {
        // Disable buttons and show message
        if (confirmBtn) {
          confirmBtn.disabled = true;
          confirmBtn.style.opacity = "0.5";
          confirmBtn.style.cursor = "not-allowed";
        }
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = "0.5";
          submitBtn.style.cursor = "not-allowed";
        }
        if (submitMessage) {
          const deadlineStr = deadline ? new Date(deadline).toLocaleString() : "";
          submitMessage.innerHTML = `<span style="color: #ef4444; font-weight: 600;">Submissions are closed.</span>${deadlineStr ? `<br><span style="font-size: 12px; color: #64748b;">Deadline was: ${deadlineStr}</span>` : ""}`;
          submitMessage.style.display = "block";
        }
      } else {
        // Enable buttons
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = "1";
          confirmBtn.style.cursor = "pointer";
        }
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = "1";
          submitBtn.style.cursor = "pointer";
        }
        if (submitMessage && submitMessage.textContent.includes("Submissions are closed")) {
          submitMessage.innerHTML = "";
          submitMessage.style.display = "none";
        }
      }
    }

    // Instructor deadline management functions
    async function loadDeadlineStatus() {
      const token = localStorage.getItem("access_token");
      if (!token) return;

      try {
        const res = await fetch(`${window.BACKEND_URL}/deadline`, {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` },
        });

        if (res.ok) {
          const data = await res.json();
          updateDeadlineUI(data.deadline, data.is_open);
        }
      } catch (err) {
        console.error("Error loading deadline:", err);
      }
    }

    // Initialize deadline dropdowns
    function initDeadlineDropdowns() {
      const daySelect = document.getElementById("deadlineDay");
      const yearSelect = document.getElementById("deadlineYear");
      const hourSelect = document.getElementById("deadlineHour");
      const minuteSelect = document.getElementById("deadlineMinute");
      const monthSelect = document.getElementById("deadlineMonth");

      // Populate days (1-31)
      if (daySelect) {
        daySelect.innerHTML = '<option value="">Day</option>';
        for (let i = 1; i <= 31; i++) {
          const val = i.toString().padStart(2, '0');
          daySelect.innerHTML += `<option value="${val}">${val}</option>`;
        }
      }

      // Populate years (current year to +10 years)
      if (yearSelect) {
        yearSelect.innerHTML = '<option value="">Year</option>';
        const currentYear = new Date().getFullYear();
        for (let i = currentYear; i <= currentYear + 10; i++) {
          yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
        }
      }

      // Populate hours (00-23)
      if (hourSelect) {
        hourSelect.innerHTML = '<option value="">Hour</option>';
        for (let i = 0; i <= 23; i++) {
          const val = i.toString().padStart(2, '0');
          hourSelect.innerHTML += `<option value="${val}">${val}</option>`;
        }
      }

      // Populate minutes (00, 15, 30, 45 or all)
      if (minuteSelect) {
        minuteSelect.innerHTML = '<option value="">Min</option>';
        for (let i = 0; i <= 59; i += 5) {
          const val = i.toString().padStart(2, '0');
          minuteSelect.innerHTML += `<option value="${val}">${val}</option>`;
        }
      }

      // Update days when month/year changes
      if (monthSelect && yearSelect && daySelect) {
        const updateDays = () => {
          const month = parseInt(monthSelect.value) || 1;
          const year = parseInt(yearSelect.value) || new Date().getFullYear();
          const daysInMonth = new Date(year, month, 0).getDate();
          const currentDay = daySelect.value;
          
          daySelect.innerHTML = '<option value="">Day</option>';
          for (let i = 1; i <= daysInMonth; i++) {
            const val = i.toString().padStart(2, '0');
            daySelect.innerHTML += `<option value="${val}">${val}</option>`;
          }
          
          if (currentDay && parseInt(currentDay) <= daysInMonth) {
            daySelect.value = currentDay;
          }
        };
        
        monthSelect.addEventListener('change', updateDays);
        yearSelect.addEventListener('change', updateDays);
      }
    }

    function updateDeadlineUI(deadline, isOpen) {
      const badge = document.getElementById("deadlineStatusBadge");
      const display = document.getElementById("currentDeadlineDisplay");

      if (badge) {
        if (isOpen) {
          badge.textContent = "OPEN";
          badge.style.background = "linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)";
          badge.style.color = "#15803d";
          badge.style.boxShadow = "0 2px 8px rgba(22, 163, 74, 0.2)";
        } else {
          badge.textContent = "CLOSED";
          badge.style.background = "linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)";
          badge.style.color = "#dc2626";
          badge.style.boxShadow = "0 2px 8px rgba(220, 38, 38, 0.2)";
        }
      }

      if (display) {
        if (deadline) {
          const dt = new Date(deadline);
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
          display.textContent = dt.toLocaleDateString('en-US', options);
        } else {
          display.textContent = "No deadline set ‚Äî submissions always open";
        }
      }

      // Populate dropdowns with current deadline
      if (deadline) {
        const dt = new Date(deadline);
        const monthSelect = document.getElementById("deadlineMonth");
        const daySelect = document.getElementById("deadlineDay");
        const yearSelect = document.getElementById("deadlineYear");
        const hourSelect = document.getElementById("deadlineHour");
        const minuteSelect = document.getElementById("deadlineMinute");
        
        if (monthSelect) monthSelect.value = (dt.getMonth() + 1).toString().padStart(2, '0');
        if (daySelect) daySelect.value = dt.getDate().toString().padStart(2, '0');
        if (yearSelect) yearSelect.value = dt.getFullYear().toString();
        if (hourSelect) hourSelect.value = dt.getHours().toString().padStart(2, '0');
        if (minuteSelect) {
          // Find closest minute option
          const mins = dt.getMinutes();
          const closest = Math.round(mins / 5) * 5;
          minuteSelect.value = (closest % 60).toString().padStart(2, '0');
        }
      }
    }

    function setupDeadlineButtons() {
      const setBtn = document.getElementById("setDeadlineBtn");
      const clearBtn = document.getElementById("clearDeadlineBtn");
      const msgEl = document.getElementById("deadlineMessage");

      // Initialize dropdowns
      initDeadlineDropdowns();

      if (setBtn) {
        setBtn.addEventListener("click", async () => {
          const token = localStorage.getItem("access_token");
          if (!token) return;

          const month = document.getElementById("deadlineMonth")?.value;
          const day = document.getElementById("deadlineDay")?.value;
          const year = document.getElementById("deadlineYear")?.value;
          const hour = document.getElementById("deadlineHour")?.value;
          const minute = document.getElementById("deadlineMinute")?.value;

          if (!month || !day || !year || !hour || !minute) {
            if (msgEl) {
              msgEl.textContent = "Please select all date and time fields.";
              msgEl.className = "msg error";
              msgEl.style.display = "block";
            }
            return;
          }

          // Build and validate the date
          const dateStr = `${year}-${month}-${day}T${hour}:${minute}`;
          const parsedDate = new Date(dateStr);
          
          if (isNaN(parsedDate.getTime())) {
            if (msgEl) {
              msgEl.textContent = "Invalid date. Please check your selection.";
              msgEl.className = "msg error";
              msgEl.style.display = "block";
            }
            return;
          }

          // Convert to ISO string
          const deadline = parsedDate.toISOString();

          try {
            const res = await fetch(`${window.BACKEND_URL}/deadline`, {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ deadline }),
            });

            if (res.ok) {
              const data = await res.json();
              updateDeadlineUI(data.deadline, data.is_open);
              if (msgEl) {
                msgEl.textContent = "Deadline set successfully!";
                msgEl.className = "msg success";
                msgEl.style.display = "block";
                setTimeout(() => { msgEl.style.display = "none"; }, 3000);
              }
            } else {
              const err = await res.json().catch(() => ({}));
              if (msgEl) {
                msgEl.textContent = err.detail || "Failed to set deadline.";
                msgEl.className = "msg error";
                msgEl.style.display = "block";
              }
            }
          } catch (err) {
            console.error("Error setting deadline:", err);
            if (msgEl) {
              msgEl.textContent = "Network error.";
              msgEl.className = "msg error";
              msgEl.style.display = "block";
            }
          }
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener("click", async () => {
          const token = localStorage.getItem("access_token");
          if (!token) return;

          try {
            const res = await fetch(`${window.BACKEND_URL}/deadline`, {
              method: "DELETE",
              headers: { "Authorization": `Bearer ${token}` },
            });

            if (res.ok) {
              updateDeadlineUI(null, true);
              // Clear all dropdowns
              ['deadlineMonth', 'deadlineDay', 'deadlineYear', 'deadlineHour', 'deadlineMinute'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
              });
              if (msgEl) {
                msgEl.textContent = "Deadline cleared. Submissions reopened!";
                msgEl.className = "msg success";
                msgEl.style.display = "block";
                setTimeout(() => { msgEl.style.display = "none"; }, 3000);
              }
            }
          } catch (err) {
            console.error("Error clearing deadline:", err);
          }
        });
      }
    }

    // Instructor functions for viewing submissions and publishing results
    async function loadSubmissionStatus() {
      const token = localStorage.getItem("access_token");
      if (!token) return;

      const statusContent = document.getElementById("submissionStatusContent");
      if (!statusContent) return;

      try {
        const res = await fetch(`${window.BACKEND_URL}/instructor/submissions`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        if (!res.ok) {
          statusContent.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #ef4444;">
              <p>Failed to load submission status.</p>
            </div>
          `;
          return;
        }

        const data = await res.json();
        const submissions = data.submissions || [];
        const totalStudents = data.total_students || 0;
        const completedCount = submissions.filter(s => s.is_complete).length;
        const inProgressCount = submissions.filter(s => !s.is_complete && s.total_submissions > 0).length;
        const notStartedCount = submissions.filter(s => s.total_submissions === 0).length;

        // Build status display
        let statusHTML = `
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
            <div style="padding: 16px; background: #ecfdf5; border-radius: 12px; border: 1px solid #a7f3d0;">
              <div style="font-size: 24px; font-weight: 700; color: #059669; margin-bottom: 4px;">${completedCount}</div>
              <div style="font-size: 12px; color: #047857; font-weight: 500;">Completed</div>
            </div>
            <div style="padding: 16px; background: #fef3c7; border-radius: 12px; border: 1px solid #fde68a;">
              <div style="font-size: 24px; font-weight: 700; color: #d97706; margin-bottom: 4px;">${inProgressCount}</div>
              <div style="font-size: 12px; color: #b45309; font-weight: 500;">In Progress</div>
            </div>
            <div style="padding: 16px; background: #f3f4f6; border-radius: 12px; border: 1px solid #d1d5db;">
              <div style="font-size: 24px; font-weight: 700; color: #6b7280; margin-bottom: 4px;">${notStartedCount}</div>
              <div style="font-size: 12px; color: #4b5563; font-weight: 500;">Not Started</div>
            </div>
          </div>
        `;

        // Show detailed list if there are submissions
        if (submissions.length > 0) {
          statusHTML += `
            <div style="max-height: 300px; overflow-y: auto;">
              <div style="font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                Student Submissions
              </div>
          `;

          submissions.forEach(sub => {
            const statusColor = sub.is_complete ? "#10b981" : (sub.total_submissions > 0 ? "#f59e0b" : "#6b7280");
            const statusText = sub.is_complete ? "‚úì Complete" : (sub.total_submissions > 0 ? "‚è≥ In Progress" : "‚óã Not Started");
            
            statusHTML += `
              <div style="padding: 12px; margin-bottom: 8px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                  <span style="font-weight: 600; color: #1e293b; font-size: 14px;">${sub.username}</span>
                  <span style="font-size: 12px; font-weight: 600; color: ${statusColor};">${statusText}</span>
                </div>
                <div style="font-size: 12px; color: #64748b;">
                  ${sub.total_submissions} / ${sub.expected_submissions} submissions (${sub.submission_percentage}%)
                </div>
              </div>
            `;
          });

          statusHTML += `</div>`;
        }

        statusContent.innerHTML = statusHTML;
      } catch (err) {
        console.error("Error loading submission status:", err);
        statusContent.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #ef4444;">
            <p>Error loading submission status. Please try again.</p>
          </div>
        `;
      }
    }

    // Instructor functions for publishing results
    async function loadPublishStatus() {
      const token = localStorage.getItem("access_token");
      if (!token) return;

      try {
        const res = await fetch(`${window.BACKEND_URL}/instructor/publish`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        const publishStatusText = document.getElementById("publishStatusText");
        if (publishStatusText) {
          if (res.ok) {
            const data = await res.json();
            if (data.published) {
              publishStatusText.textContent = "Published";
              publishStatusText.style.color = "#10b981";
            } else {
              publishStatusText.textContent = "Not Published";
              publishStatusText.style.color = "#f59e0b";
            }
          } else {
            publishStatusText.textContent = "Unknown";
            publishStatusText.style.color = "#6b7280";
          }
        }
      } catch (err) {
        console.error("Error checking publish status:", err);
        const publishStatusText = document.getElementById("publishStatusText");
        if (publishStatusText) {
          publishStatusText.textContent = "Error";
          publishStatusText.style.color = "#ef4444";
        }
      }
    }

    function setupPublishButton() {
      const publishBtn = document.getElementById("publishResultsBtn");
      if (!publishBtn) return;

      publishBtn.addEventListener("click", async () => {
        const token = localStorage.getItem("access_token");
        if (!token) {
          setPublishMessage("You are not logged in.", "error");
          return;
        }

        // Confirm before publishing
        if (!confirm("Are you sure you want to publish the peer review results? This will make them visible to all students.")) {
          return;
        }

        // Disable button
        publishBtn.disabled = true;
        const buttonText = publishBtn.querySelector("span:last-child");
        const originalText = buttonText ? buttonText.textContent : "Publish Results";
        if (buttonText) {
          buttonText.textContent = "Publishing...";
        }

        try {
          console.log("Publishing results...");
          const res = await fetch(`${window.BACKEND_URL}/instructor/publish`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${token}`,
            },
          });

          console.log("Publish response status:", res.status, res.statusText);

          if (res.ok) {
            const data = await res.json().catch(() => ({}));
            console.log("Publish response data:", data);
            
            const successMsg = data.message || "‚úì Results published successfully! Students can now view their reports.";
            
            if (data.already_published) {
              setPublishMessage("Results published successfully", "success");
            } else {
              setPublishMessage(successMsg, "success");
            }
            
            // Update status and refresh submission status and student reports
            loadPublishStatus();
            loadSubmissionStatus();
            loadStudentReports();
            
            console.log("Results published successfully. Students should refresh their dashboard to see reports.");
          } else {
            const data = await res.json().catch(() => ({}));
            const errorMsg = data.detail || `Failed to publish results (HTTP ${res.status})`;
            setPublishMessage(errorMsg, "error");
          }
        } catch (err) {
          console.error("Error publishing results:", err);
          setPublishMessage("Network error: Failed to publish results. Please check your connection.", "error");
        } finally {
          publishBtn.disabled = false;
          if (buttonText) {
            buttonText.textContent = originalText;
          }
        }
      });
    }

    function setPublishMessage(message, type) {
      const msgEl = document.getElementById("publishMessage");
      if (!msgEl) return;

      msgEl.textContent = message;
      msgEl.className = `msg ${type}`;
      msgEl.style.display = message ? "block" : "none";

      // Clear success messages after 5 seconds
      if (type === "success") {
        setTimeout(() => {
          msgEl.textContent = "";
          msgEl.style.display = "none";
        }, 5000);
      }
    }

    // Load and display student reports in instructor controls
    async function loadStudentReports() {
      const token = localStorage.getItem("access_token");
      if (!token) {
        console.error("No access token found for loading student reports");
        return;
      }

      const reportsList = document.getElementById("studentReportsList");
      if (!reportsList) {
        console.error("studentReportsList element not found");
        return;
      }

      console.log("Loading student reports...");

      try {
        // Get all students
        const studentsRes = await fetch(`${window.BACKEND_URL}/instructor/students`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        if (!studentsRes.ok) {
          const errorData = await studentsRes.json().catch(() => ({}));
          console.error("Failed to load students:", studentsRes.status, errorData);
          reportsList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #ef4444;">
              <p>Failed to load students (HTTP ${studentsRes.status}).</p>
              <p style="font-size: 12px; margin-top: 8px;">${errorData.detail || 'Please check console for details'}</p>
            </div>
          `;
          return;
        }

        const studentsData = await studentsRes.json();
        const students = studentsData.students || [];

        console.log(`Found ${students.length} students`);

        if (students.length === 0) {
          reportsList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #64748b;">
              <p>No students found.</p>
            </div>
          `;
          return;
        }

        // Fetch report for each student
        const reportPromises = students.map(async (student) => {
          try {
            const reportRes = await fetch(`${window.BACKEND_URL}/peer-reviews/report?student_id=${student.id}`, {
              method: "GET",
              headers: {
                "Authorization": `Bearer ${token}`,
              },
            });

            if (reportRes.ok) {
              const reportData = await reportRes.json();
              return {
                student: student,
                report: reportData,
                hasReport: true,
              };
            } else {
              return {
                student: student,
                report: null,
                hasReport: false,
              };
            }
          } catch (err) {
            console.error(`Error fetching report for student ${student.id}:`, err);
            return {
              student: student,
              report: null,
              hasReport: false,
            };
          }
        });

        const results = await Promise.all(reportPromises);

        // Build HTML for student reports list
        let reportsHTML = '';
        
        if (results.length === 0) {
          reportsHTML = `
            <div style="text-align: center; padding: 20px; color: #64748b;">
              <p>No students found.</p>
            </div>
          `;
        } else {
          // Filter to only show students with scores (hasReport and overallScore is not null/undefined)
          const studentsWithScores = results.filter(result => {
            return result.hasReport && 
                   result.report && 
                   result.report.overall_score !== null && 
                   result.report.overall_score !== undefined;
          });

          if (studentsWithScores.length === 0) {
            reportsHTML = `
              <div style="text-align: center; padding: 20px; color: #64748b;">
                <p>No students with scores available yet.</p>
                <p style="font-size: 12px; margin-top: 8px;">Students will appear here once they receive peer reviews and results are published.</p>
              </div>
            `;
          } else {
            studentsWithScores.forEach((result) => {
              const { student, report, hasReport } = result;
              const overallScore = report?.overall_score;
              const totalReviews = report?.total_reviews || 0;
              const uniqueReviewers = report?.unique_reviewers || 0;

              // Determine score color
              let scoreColor = "#6b7280";
              let scoreText = "N/A";
              if (hasReport && overallScore !== null && overallScore !== undefined) {
                scoreText = overallScore.toFixed(2);
                if (overallScore >= 4) {
                  scoreColor = "#10b981";
                } else if (overallScore >= 3) {
                  scoreColor = "#f59e0b";
                } else {
                  scoreColor = "#ef4444";
                }
              }

              reportsHTML += `
                <div class="student-report-item" style="padding: 16px; margin-bottom: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #1e293b; font-size: 14px;">${student.username}</div>
                    </div>
                    <div style="text-align: right; margin-left: 16px;">
                      <div style="font-size: 24px; font-weight: bold; color: ${scoreColor};">
                        ${scoreText}
                      </div>
                      <div style="font-size: 10px; color: #64748b;">Score</div>
                    </div>
                  </div>
                </div>
              `;
            });
          }
        }

        reportsList.innerHTML = reportsHTML;
        console.log("Student reports HTML updated");

      } catch (err) {
        console.error("Error loading student reports:", err);
        console.error("Error details:", err.message, err.stack);
        reportsList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #ef4444;">
            <p>Error loading student reports.</p>
            <p style="font-size: 12px; margin-top: 8px; color: #64748b;">${err.message || 'Please check console for details'}</p>
            <button onclick="loadStudentReports()" class="submit-btn-primary" style="margin-top: 12px; padding: 8px 16px; font-size: 14px;">
              <span class="btn-icon">üîÑ</span>
              <span>Retry</span>
            </button>
          </div>
        `;
      }
    }
  </script>
</body>
</html>